/******************************************************************************
Header
******************************************************************************/
// $Header: //MyDataDepot/Projects/provenance-autoType2/haathi/src/lib/com/haathi/exploit/EvtDelete.cpp#1 $
/*

In general, this produces an invalid event that fails the evolution test.
When the event is played forward, the audit is messed up.  All events
down to document creation fail the evolution.

*/
/******************************************************************************
Include self
******************************************************************************/
#include "com/haathi/exploit/EvtDelete.hpp"
/******************************************************************************
Include others
******************************************************************************/
#include "com/haathi/document/CloudProvenanceDocument.hpp"
#include "com/haathi/text/Selection.hpp"
#include "com/haathi/provenance/text/DeleteTextProvenance.hpp"
#include "com/haathi/text/TextHelper.hpp"

#include <vector>
/******************************************************************************
Define
******************************************************************************/

/******************************************************************************
Using
******************************************************************************/
using com::haathi::document::CloudProvenanceDocument;
using com::haathi::provenance::DeleteTextProvenance;
using com::haathi::text::Selection;
using com::haathi::text::TextHelper;

using com::sun::star::lang::XComponent;

using namespace com::sun::star::uno;
/******************************************************************************
Namespace
******************************************************************************/
namespace com {
	namespace haathi {
		namespace exploit {
/******************************************************************************
Class
******************************************************************************/
#if EXPLOIT == EXPLOIT_EVT_DELETE

EvtDelete evtDelete(OUSTRING("*evtText*"));

EvtDelete::EvtDelete(OUString evtText): evtText(evtText), hacked(false) {
	pExploit = this;
}

bool EvtDelete::isEnabled() {
	return !hacked;
}

void EvtDelete::captureXComponent(Reference<XComponent> xComponent) {
	this->xComponent = xComponent;
	hacked = false;
}

void EvtDelete::captureCloudProvenanceDocument(CloudProvenanceDocument* pCloudProvenanceDocument) {
	this->pCloudProvenanceDocument = pCloudProvenanceDocument;
}

void EvtDelete::release() {
	xComponent.clear();
}

void EvtDelete::hack() {
	// Find out where the cursor is
	TextHelper textHelper(xComponent);
	std::vector<Selection> selections = textHelper.getSelections();
	sal_Int32 offset = selections[0].getOffset();

	// Add the event
	DeleteTextProvenance* deleteTextProvenance = new DeleteTextProvenance((int) offset, evtText);
	pCloudProvenanceDocument->addProvenanceEvent(deleteTextProvenance);

	hacked = true;
}

#else

	DUMMY_CODE;

#endif
/******************************************************************************
Namespace
******************************************************************************/
		};
	};
};
/*****************************************************************************/
